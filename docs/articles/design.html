<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Designing Transforms • cdata</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Designing Transforms">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cdata</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/cdata.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/blocksrecs.html">Block Records and Row Records</a>
    </li>
    <li>
      <a href="../articles/design.html">Designing Transforms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Designing Transforms</h1>
                        <h4 class="author">John Mount, Nina Zumel</h4>
            
            <h4 class="date">2018-10-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/cdata//blob/master/vignettes/design.Rmd"><code>vignettes/design.Rmd</code></a></small>
      <div class="hidden name"><code>design.Rmd</code></div>

    </div>

    
    
<p>The question comes up: how do you design the control table that implements a given transform.</p>
<p>Let’s discuss that with an example: <a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">plotting the <code>iris</code> data faceted</a>.</p>
<p>To produce the following graph with <code>ggplot2</code></p>
<p><img src="iris_plot.png"></p>
<p>One wants data that looks like the following:</p>
<p><img src="design_2.png" width="600"></p>
<p>Notice <code>Species</code> is in a column so we can use it to choose colors. Also, <code>flower_part</code> is in a column so we can use it to facet.</p>
<p>However, <code>iris</code> data starts in the following format.</p>
<p><img src="design_1.png" width="600"></p>
<p>So we want to transform one to the other before plotting.</p>
<p><img src="design_3.png" width="600"></p>
<p>There are a great number of ways to achieve the above transform. We are going to concentrate on the <code>cdata</code> methodology.<br>
Notice we are moving data from an “all of the record is in one row” to “the meaningful record unit in a block across several rows”. In <code>cdata</code> this means we want to perform a <code><a href="../reference/rowrecs_to_blocks.html">rowrecs_to_blocks()</a></code> transform. To do this we start by labeling the roles of different portion of the data we want and headers in our desired result record. In particular we identify:</p>
<ul>
<li>Columns we want copied as additional row information (or even as partial row keys).</li>
<li>An additional partial row key column.</li>
<li>Levels we expect in the new partial row key column.</li>
<li>New column names for the new <code>data.frame</code>.</li>
</ul>
<p>We show this below.</p>
<p><img src="design_4.png" width="600"></p>
<p>We then fill this information into a new data structure we call the control table.</p>
<p>The rules are:</p>
<ul>
<li>The key column is the first column of the control table.</li>
<li>The key levels we wish to track are values in the key column.</li>
<li>The column names of the control table are the new column names we will produce in our result.</li>
<li>The block of values seen in our example record are replaced by a the column names these values were taken from in the original data.</li>
<li>Any other columns we want copied are specified in the <code>columnsToCopy</code> argument.</li>
</ul>
<p><img src="design_5.png" width="600"></p>
<p>We then translate this diagram into a <code>controlTabl</code> <code>data.frame</code> and <code>columnsToCopy</code> vector.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(controlTable &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/wrapr/topics/qchar_frame">qchar_frame</a></span>(
  flower_part, Length      , Width       <span class="op">|</span>
<span class="st">  </span>Petal      , Petal.Length, Petal.Width <span class="op">|</span>
<span class="st">  </span>Sepal      , Sepal.Length, Sepal.Width ))
<span class="co">#&gt;   flower_part       Length       Width</span>
<span class="co">#&gt; 1       Petal Petal.Length Petal.Width</span>
<span class="co">#&gt; 2       Sepal Sepal.Length Sepal.Width</span>

(columnsToCopy &lt;-<span class="st"> "Species"</span>)
<span class="co">#&gt; [1] "Species"</span></code></pre></div>
<p>And we can now perform the transform.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"cdata"</span>)

iris_aug &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rowrecs_to_blocks.html">rowrecs_to_blocks</a></span>(
  iris,
  controlTable,
  <span class="dt">columnsToCopy =</span> <span class="st">"Species"</span>) 
<span class="kw">head</span>(iris_aug)
<span class="co">#&gt;   Species flower_part Length Width</span>
<span class="co">#&gt; 1  setosa       Petal    1.4   0.2</span>
<span class="co">#&gt; 2  setosa       Sepal    5.1   3.5</span>
<span class="co">#&gt; 3  setosa       Petal    1.4   0.2</span>
<span class="co">#&gt; 4  setosa       Sepal    4.9   3.0</span>
<span class="co">#&gt; 5  setosa       Petal    1.3   0.2</span>
<span class="co">#&gt; 6  setosa       Sepal    4.7   3.2</span></code></pre></div>
<p>And that completes the example plot as described <a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">here</a>.</p>
<p>Designing a <code>rowrecs_to_blocks</code> transform is even easier, as the <code>controlTable</code> has the same shape is the record block (assuming the record partial key controlling column is the first column). All one has to do is replace the value in such an example record with the desired column names.</p>
<p>For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grab a record to use to build our control table </span>
ct &lt;-<span class="st"> </span>iris_aug[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw">c</span>(<span class="st">"flower_part"</span>, <span class="st">"Length"</span>, <span class="st">"Width"</span>)]
<span class="kw">print</span>(ct)
<span class="co">#&gt;   flower_part Length Width</span>
<span class="co">#&gt; 1       Petal    1.4   0.2</span>
<span class="co">#&gt; 2       Sepal    5.1   3.5</span>

<span class="co"># replace values with desired column names</span>
<span class="co"># as in this case the values are unique we can do</span>
<span class="co"># this mechanically, normally we do this by hand</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(ct)) {
  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(ct)) {
    ct[i,j] &lt;-<span class="st"> </span><span class="kw">colnames</span>(iris)[<span class="kw">which</span>(iris[<span class="dv">1</span>,]<span class="op">==</span>ct[i,j])]
  }
}

<span class="kw">print</span>(ct)
<span class="co">#&gt;   flower_part       Length       Width</span>
<span class="co">#&gt; 1       Petal Petal.Length Petal.Width</span>
<span class="co">#&gt; 2       Sepal Sepal.Length Sepal.Width</span></code></pre></div>
<p>Though to invert such a transform we would need additional keys showing which rows together form a record (which we demonstrate <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a>).</p>
<p>Notice having an example record in each form (<code>iris_aug[1:2, c("flower_part", "Length", "Width")]</code> and <code>iris[1,]</code>) is enough to build up the control table (either by machine on using pencil and paper). In practice: we <em>highly</em> recommend looking at your data, writing down what one record on each side of the transform would look like, and then using that to fill out the control table on paper.</p>
<p>Some discussion of the nature of records in <code>cdata</code> can be found <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a>.</p>
<p>Some additional tutorials on <code>cdata</code> data transforms can are given below:</p>
<ul>
<li><a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">The faceted plot example</a></li>
<li><a href="http://winvector.github.io/FluidData/FluidDataReshapingWithCdata.html">Fluid data reshaping with cdata</a></li>
<li><a href="https://youtu.be/4cYbP3kbc0k">short free cdata screencast</a></li>
<li><a href="http://winvector.github.io/FluidData/RowsAndColumns.html">“Coordinatized data” theory</a></li>
<li><a href="http://winvector.github.io/FluidData/FluidData.html">The “fluid data” methodology</a></li>
<li>
<a href="http://winvector.github.io/FluidData/DataWranglingAtScale.html">another worked example</a>.</li>
</ul>
</div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
