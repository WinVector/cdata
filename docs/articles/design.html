<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Designing Transforms for Data Reshaping with cdata • cdata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Designing Transforms for Data Reshaping with cdata">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/cdata.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/blocksrecs.html">Block Records and Row Records</a>
    </li>
    <li>
      <a href="../articles/control_table_keys.html">Control Table Keys</a>
    </li>
    <li>
      <a href="../articles/design.html">Designing Transforms for Data Reshaping with cdata</a>
    </li>
    <li>
      <a href="../articles/general_transform.html">General Data Transforms With cdata</a>
    </li>
    <li>
      <a href="../articles/operators.html">Operators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Designing Transforms for Data Reshaping with cdata</h1>
                        <h4 class="author">John Mount, Nina Zumel</h4>
            
            <h4 class="date">2019-04-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/cdata/blob/master/vignettes/design.Rmd"><code>vignettes/design.Rmd</code></a></small>
      <div class="hidden name"><code>design.Rmd</code></div>

    </div>

    
    
<p>This note is about the design of data transforms using the <a href="https://CRAN.R-project.org/package=cdata"><code>cdata</code></a> package. The <code>cdata</code> packages demonstrates the <a href="http://winvector.github.io/FluidData/RowsAndColumns.html">“coordinatized data” theory</a> and includes an implementation of the <a href="http://winvector.github.io/FluidData/FluidData.html">“fluid data” methodology</a> for general data re-shaping.</p>
<p><a href="https://CRAN.R-project.org/package=cdata"><code>cdata</code></a> adheres to the so-called “Rule of Representation”:</p>
<blockquote>
<p>Fold knowledge into data, so program logic can be stupid and robust.</p>
<p><a href="http://www.catb.org/esr/writings/taoup/html/ch01s06.html#id2878263"><em>The Art of Unix Programming</em>, Erick S. Raymond, Addison-Wesley , 2003</a></p>
</blockquote>
<p>The design principle expressed by this rule is that it is much easier to reason about data than to try to reason about code, so using data to control your code is often a very good trade-off.</p>
<p>We showed in <a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">this article</a> how <code>cdata</code> takes a transform control table to specify how you want your data reshaped. The question then becomes: how do you come up with the transform control table?</p>
<p>Let’s discuss that using the example from the article: <a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">“plotting the <code>iris</code> data faceted”</a>.</p>
<p>The goal is to produce the following graph with <code>ggplot2</code></p>
<p><img src="iris_plot.png"></p>
<p>In order to do this, one wants data that looks like the following:</p>
<p><img src="design_2.png" width="600"></p>
<p>Notice <code>Species</code> is in a column so we can use it to choose colors. Also, <code>flower_part</code> is in a column so we can use it to facet.</p>
<p>However, <code>iris</code> data starts in the following format.</p>
<p><img src="design_1.png" width="600"></p>
<p>We call this form a <em>row record</em> because all the information about a single entity (a “record”) lies in a single row. When the information about an entity is distributed across several rows (in whatever shape), we call that a <em>block record</em>. So the goal is to transform the row records in <code>iris</code> into the desired block records before plotting.</p>
<p><img src="design_3.png" width="600"></p>
<p>This new block record is partially keyed by the <code>flower_part</code> column, which tells us which piece of a record a row corresponds to (the petal information, or the sepal information). We could also add an <code>iris_id</code> as a per-record key; this we are not adding, as we do not need it for our graphing task. However, adding a per-record id makes the transform invertible, as is shown <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a>.</p>
<p>There are a great number of ways to achieve the above transform. We are going to concentrate on the <code>cdata</code> methodology. We want to move data from an “all of the record is in one row” format to “the meaningful record unit is a block across several rows” format. In <code>cdata</code> this means we want to perform a <code><a href="../reference/rowrecs_to_blocks.html">rowrecs_to_blocks()</a></code> transform. To do this we start by labeling the roles of different portion of the block oriented data example. In particular we identify:</p>
<ul>
<li>Columns we want copied as additional row information (in this case <code>Species</code>, but often a per-record index or key).</li>
<li>The additional key that identifies parts of each multi-row record (in this case <code>flower_part</code>).</li>
<li>Levels we expect in the new record portion key column (<code>Petal</code> and <code>Sepal</code>).</li>
<li>New column names for the new <code>data.frame</code>. These will go where values are currently in the block record data.</li>
</ul>
<p>We show this labeling below.</p>
<p><img src="design_4.png" width="600"></p>
<p>Notice we have marked the measurements <code>1.4, 0.2, 5.1, 3.5</code> as “column names”, not values. That is because we must show which columns in the original data frame these values are coming from.</p>
<p>This annotated example record is the guide for building what we call the transform control table. We build up the transform control table following these rules:</p>
<ul>
<li>The key column is the first column of the control table.</li>
<li>The key levels we wish to track are values in the key column.</li>
<li>The column names of the control table are the new column names we will produce in our result.</li>
<li>The block of values seen in our example record are replaced by the names of the columns that these values were taken from in the original data.</li>
<li>Any other columns we want copied are specified in the <code>columnsToCopy</code> argument.</li>
</ul>
<p><img src="design_5.png" width="600"></p>
<p>The <code>R</code> version of the above is specified as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(controlTable &lt;-<span class="st"> </span>wrapr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/wrapr/topics/qchar_frame">qchar_frame</a></span>(
  <span class="st">"flower_part"</span>, <span class="st">"Length"</span>    , <span class="st">"Width"</span>     <span class="op">|</span>
<span class="st">  "Petal"</span>      , Petal.Length, Petal.Width <span class="op">|</span>
<span class="st">  "Sepal"</span>      , Sepal.Length, Sepal.Width ))
<span class="co">#&gt;   flower_part       Length       Width</span>
<span class="co">#&gt; 1       Petal Petal.Length Petal.Width</span>
<span class="co">#&gt; 2       Sepal Sepal.Length Sepal.Width</span>

(columnsToCopy &lt;-<span class="st"> "Species"</span>)
<span class="co">#&gt; [1] "Species"</span></code></pre></div>
<p>And we can now perform the transform.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"cdata"</span>)

iris_aug &lt;-<span class="st"> </span><span class="kw"><a href="../reference/rowrecs_to_blocks.html">rowrecs_to_blocks</a></span>(
  iris,
  <span class="dt">controlTable =</span> controlTable,
  <span class="dt">columnsToCopy =</span> columnsToCopy) 

<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(iris_aug)
<span class="co">#&gt;   Species flower_part Length Width</span>
<span class="co">#&gt; 1  setosa       Petal    1.4   0.2</span>
<span class="co">#&gt; 2  setosa       Sepal    5.1   3.5</span>
<span class="co">#&gt; 3  setosa       Petal    1.4   0.2</span>
<span class="co">#&gt; 4  setosa       Sepal    4.9   3.0</span>
<span class="co">#&gt; 5  setosa       Petal    1.3   0.2</span>
<span class="co">#&gt; 6  setosa       Sepal    4.7   3.2</span></code></pre></div>
<p>The data is now ready to plot using <code>ggplot2</code> as was shown <a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">here</a>.</p>
<p>Designing a <code>blocks_to_rowrecs</code> transform is even easier, as the <code>controlTable</code> has the same shape as the incoming record block (assuming the record partial key controlling column is the first column). All one has to do is replace the values in such an example record with the desired column names.</p>
<p>For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grab a record to use to build our control table </span>
ct &lt;-<span class="st"> </span>iris_aug[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"flower_part"</span>, <span class="st">"Length"</span>, <span class="st">"Width"</span>)]
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(ct)
<span class="co">#&gt;   flower_part Length Width</span>
<span class="co">#&gt; 1       Petal    1.4   0.2</span>
<span class="co">#&gt; 2       Sepal    5.1   3.5</span>

<span class="co"># replace values with desired column names</span>
<span class="co"># as in this case the values are unique we can do</span>
<span class="co"># this mechanically, normally we do this by hand</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(ct)) {
  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(ct)) {
    ct[i,j] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(iris)[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(iris[<span class="dv">1</span>,]<span class="op">==</span>ct[i,j])]
  }
}

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(ct)
<span class="co">#&gt;   flower_part       Length       Width</span>
<span class="co">#&gt; 1       Petal Petal.Length Petal.Width</span>
<span class="co">#&gt; 2       Sepal Sepal.Length Sepal.Width</span></code></pre></div>
<p>Though to actually move back from block records to row records we would need additional record id keys showing <em>which</em> rows together form a record (which we demonstrate <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a>).</p>
<p>Notice in both cases that having examples of the before and after form of the transform is the guide to building the transform specification, that is, the transform control table. In practice: we <em>highly</em> recommend looking at your data, writing down what a single record on each side of the transform would look like, and then using that to fill out the control table on paper.</p>
<p>The exercise of designing a control table really opens your eyes to how data is moving in such transforms and exposes a lot of structure of data transforms. For example:</p>
<ul>
<li>If the control table has two columns (one key column, one value column) then the operation could be implemented as a single <code>tidyr</code> <code>gather()</code> or <code>spread()</code>.</li>
<li>If the control table has <code>k</code> rows then the <code><a href="../reference/rowrecs_to_blocks.html">rowrecs_to_blocks()</a></code> direction could be implemented as <code>k-1</code> <code><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind()</a></code>s.</li>
</ul>
<p>Some discussion of the nature of block records and row records in <code>cdata</code> can be found <a href="https://winvector.github.io/cdata/articles/blocksrecs.html">here</a>.</p>
<p>Some additional tutorials on <code>cdata</code> data transforms can are given below:</p>
<ul>
<li><a href="http://www.win-vector.com/blog/2018/10/faceted-graphs-with-cdata-and-ggplot2/">The faceted plot example</a></li>
<li><a href="http://winvector.github.io/FluidData/FluidDataReshapingWithCdata.html">Fluid data reshaping with cdata</a></li>
<li><a href="https://youtu.be/4cYbP3kbc0k">short free cdata screencast</a></li>
<li><a href="http://winvector.github.io/FluidData/RowsAndColumns.html">“Coordinatized data” theory</a></li>
<li><a href="http://winvector.github.io/FluidData/FluidData.html">The “fluid data” methodology</a></li>
<li>
<a href="http://winvector.github.io/FluidData/DataWranglingAtScale.html">another worked example</a>.</li>
</ul>
</div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
