---
title: "PlotExample"
author: "Win-Vector LLC"
date: "12/20/2017"
output: github_document
---

```{r setup}
library("ggplot2")
library("cdata")
library("seplyr")

d <- readRDS("metrics.rds")
d$epoch <- seq_len(nrow(d))
head(d)
```

```{r firstplot}
cT <- buildUnPivotControlTable(
  nameForNewKeyColumn= 'orig_col_name',
  nameForNewValueColumn= 'performance',
  columnsToTakeFrom= c('val_loss',
                       'val_acc',
                       'loss',
                       'acc' ))
dT <- moveValuesToRowsD(
  d,
  controlTable = cT,
  columnsToCopy = "epoch")
head(dT)

mp <- data.frame(
  orig_col_name = qc(val_loss, val_acc, 
                     loss, acc),
  dataset = qc("validation", "validation", 
               "training", "training"),
  measure = qc("binary cross entropy", "accuracy",
               "binary cross entropy", "accuracy"),
  stringsAsFactors = FALSE)
print(mp)


dT <- map_fieldsD(dT, 
                  "orig_col_name",
                  mp)
head(dT)

pick <- dT %.>%
  filter_se(.,
            qe(measure == "binary cross entropy",
               dataset == "validation")) %.>%
  .$epoch[[which.min(.$performance)]]

ggplot(data = dT, 
       aes(x = epoch, 
           y = performance,
           color = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~measure, ncol=1, scales = "free_y") +
  geom_vline(xintercept = pick, alpha=0.7, color='darkgreen') +
  scale_color_brewer(palette = "Dark2") + 
  ggtitle("model performance by epoch, dataset, and measure")
```


```{r lineplot}
print(head(d, n=1))

cT <- dplyr::tribble(
  ~measure,               ~training, ~validation,
  "binary cross entropy", "loss",    "val_loss",
  "accuracy",              "acc",     "val_acc"
)
print(cT)

dT <- moveValuesToRowsD(
  d,
  controlTable = cT,
  columnsToCopy = "epoch")
print(head(dT))

pick <- dT %.>%
  filter_se(.,
            qe(measure == "binary cross entropy")) %.>%
  .$epoch[[which.min(.$validation)]]


ggplot(data = dT, 
       aes(x = epoch,
           xend = epoch,
           y = validation,
           yend = training,
           ymin = pmin(validation, training),
           ymax = pmax(validation, training))) +
  geom_segment() +
  geom_point() +
  geom_point(aes(y = training), shape = 3) +
  geom_smooth(se = FALSE) +
  geom_ribbon(alpha=0.2) +
  geom_vline(xintercept = pick, alpha=0.7, color='darkgreen') +
  facet_wrap(~measure, ncol=1, scales = 'free_y') +
  ylab("performance") +
  ggtitle("plotting over-fit as a function of epoch")
```
